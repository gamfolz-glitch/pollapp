{% extends "dashboard/base.html" %}

{% block dashboard_title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {{ poll.title }}{% endblock %}

{% block extra_css %}
  <style>
    @media (max-width: 768px) {
      .chart-container {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <a href="/dashboard/project/{{ poll.id }}/" class="btn btn-outline" style="margin-bottom: 1.5rem;">‚Üê –ù–∞–∑–∞–¥ –∫ –æ–ø—Ä–æ—Å—É</a>

  <div class="flex flex-between" style="margin-bottom: 1.5rem;">
    <div>
      <h1>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
      <h2 style="color: var(--text-light); font-size: 1.25rem; font-weight: 400;">{{ poll.title }}</h2>
    </div>
    <a href="/dashboard/project/{{ poll.id }}/responses/" class="btn btn-secondary">
       –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–≤–µ—Ç–æ–≤
    </a>
  </div>

  <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white;">
    <div class="grid grid-3" style="gap: 1.5rem;">
      <div style="text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">{{ total_submissions }}</div>
        <div style="opacity: 0.9;">–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫</div>
      </div>
      <div style="text-align: center;">
        <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">{{ poll.access_code }}</div>
        <div style="opacity: 0.9;">–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</div>
      </div>
      <div style="text-align: center;">
        <a href="/p/{{ poll.access_code }}/" target="_blank" style="color: white; text-decoration: underline; opacity: 0.9;">
          –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ ‚Üí
        </a>
      </div>
    </div>
  </div>

  <style>
    .bar-row { 
      display: flex; 
      align-items: center; 
      gap: 1rem; 
      margin: 0.75rem 0; 
      padding: 0.5rem;
    }
    .bar-label { 
      width: 250px; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap;
      font-weight: 500;
    }
    .bar-wrap { 
      flex: 1; 
      background: var(--bg-card); 
      height: 24px; 
      position: relative; 
      border-radius: 9999px;
      overflow: hidden;
    }
    .bar-fill { 
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); 
      height: 100%;
      border-radius: 9999px;
      transition: width 0.3s ease;
    }
    .bar-num { 
      width: 140px; 
      text-align: right; 
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: var(--text);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    
    table th {
      background: var(--bg);
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
    }
    
    table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
    }
    
    table tr:hover {
      background: var(--bg);
    }
  </style>

  {% if questions_stats %}
    {% for q in questions_stats %}
      <div class="card">
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
          <span style="background: var(--primary); color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">
            {{ forloop.counter }}
          </span>
          <div style="flex: 1;">
            <h3 style="margin-bottom: 0.25rem;">{{ q.text }}</h3>
            <span class="badge {% if q.kind == 'TEXT' %}badge-primary{% elif q.kind == 'SINGLE' %}badge-success{% else %}badge-warning{% endif %}">
              {% if q.kind == 'TEXT' %}üìù –¢–µ–∫—Å—Ç
              {% elif q.kind == 'SINGLE' %}üîò –û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä
              {% else %}‚òëÔ∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
              {% endif %}
            </span>
          </div>
        </div>

        {% if q.kind == 'TEXT' %}
          <div style="padding: 1.5rem; background: var(--bg); border-radius: 0.5rem; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;">{{ q.text_answers_count }}</div>
            <div style="color: var(--text-light); margin-bottom: 1rem;">–¢–µ–∫—Å—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
            <a href="/dashboard/project/{{ poll.id }}/responses/?text=&limit=200" class="btn btn-outline">
               –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
            </a>
          </div>
        {% else %}
          {% if q.choices %}
            <div class="chart-container" style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <h4 style="margin-bottom: 1rem; color: var(--text-light); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">üìä –î–∏–∞–≥—Ä–∞–º–º–∞</h4>
                <div style="position: relative; height: 320px;">
                  <canvas
                    id="chart-{{ q.id }}"
                    data-chart="stats"
                    data-kind="{{ q.kind }}"
                    data-labels='[{% for c in q.choices %}"{{ c.text|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}]'
                    data-values='[{% for c in q.choices %}{{ c.count }}{% if not forloop.last %},{% endif %}{% endfor %}]'
                  ></canvas>
                </div>
              </div>

              <div style="margin-top: 0.5rem;">
                <h4 style="margin-bottom: 0.75rem; color: var(--text-light); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">–î–µ—Ç–∞–ª–∏</h4>
                <ul class="list">
                  {% for c in q.choices %}
                    {% cycle '#6366f1' '#8b5cf6' '#10b981' '#f59e0b' '#ef4444' '#3b82f6' '#ec4899' '#22c55e' '#0ea5e9' '#f472b6' '#fbbf24' '#4f46e5' '#4338ca' '#0f766e' '#5eead4' '#94a3b8' as choice_color silent %}
                    <li class="list-item" data-choice-color="{{ choice_color }}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem;">
                      <span class="choice-info" style="display: flex; align-items: center; gap: 0.5rem; flex: 1; margin-right: 0.5rem;">
                        <span class="choice-dot" style="width: 12px; height: 12px; border-radius: 9999px; background: currentColor;"></span>
                        <span class="choice-text">{{ c.text }}</span>
                      </span>
                      <span class="choice-meta" style="font-weight: 700;">{{ c.percent|floatformat:0 }}% ({{ c.count }})</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>

          {% else %}
            <div class="empty-state" style="padding: 2rem;">
              <p style="color: var(--text-light);">–ü–æ–∫–∞ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.</p>
            </div>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <div class="card empty-state">
      <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
      <h3>–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</h3>
      <p style="margin: 1rem 0; color: var(--text-light);">
        –î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –∫ –æ–ø—Ä–æ—Å—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
      </p>
      <a href="/dashboard/project/{{ poll.id }}/question/new/" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</a>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (typeof Chart === "undefined") return;

      const baseColors = [
        { bg: "rgba(99, 102, 241, 0.8)", border: "rgba(99, 102, 241, 1)" },   // indigo
        { bg: "rgba(139, 92, 246, 0.8)", border: "rgba(139, 92, 246, 1)" },  // purple
        { bg: "rgba(16, 185, 129, 0.8)", border: "rgba(16, 185, 129, 1)" },  // green
        { bg: "rgba(245, 158, 11, 0.8)", border: "rgba(245, 158, 11, 1)" },  // amber
        { bg: "rgba(239, 68, 68, 0.8)", border: "rgba(239, 68, 68, 1)" },    // red
        { bg: "rgba(59, 130, 246, 0.8)", border: "rgba(59, 130, 246, 1)" },  // blue
        { bg: "rgba(236, 72, 153, 0.8)", border: "rgba(236, 72, 153, 1)" },  // pink
        { bg: "rgba(34, 197, 94, 0.8)", border: "rgba(34, 197, 94, 1)" },    // emerald
        { bg: "rgba(14, 165, 233, 0.8)", border: "rgba(14, 165, 233, 1)" },  // sky
        { bg: "rgba(244, 114, 182, 0.8)", border: "rgba(244, 114, 182, 1)" },// rose
        { bg: "rgba(251, 191, 36, 0.8)", border: "rgba(251, 191, 36, 1)" },  // yellow
        { bg: "rgba(79, 70, 229, 0.8)", border: "rgba(79, 70, 229, 1)" },    // indigo deep
        { bg: "rgba(67, 56, 202, 0.8)", border: "rgba(67, 56, 202, 1)" },    // violet deep
        { bg: "rgba(15, 118, 110, 0.8)", border: "rgba(15, 118, 110, 1)" },  // teal
        { bg: "rgba(94, 234, 212, 0.8)", border: "rgba(94, 234, 212, 1)" },  // teal light
        { bg: "rgba(148, 163, 184, 0.8)", border: "rgba(148, 163, 184, 1)" },// slate
      ];

      function normalizePercents(values) {
        const total = values.reduce((a, b) => a + b, 0);
        if (total === 0) return values.map(() => 0);

        let raw = values.map((v) => (v / total) * 100);
        let rounded = raw.map((v) => Math.round(v));
        let diff = 100 - rounded.reduce((a, b) => a + b, 0);

        while (diff !== 0) {
          for (let i = 0; i < rounded.length && diff !== 0; i++) {
            if (diff > 0) {
              rounded[i] += 1;
              diff -= 1;
            } else if (rounded[i] > 0) {
              rounded[i] -= 1;
              diff += 1;
            }
          }
        }
        return rounded;
      }

      function initChart(canvas) {
        const labels = JSON.parse(canvas.dataset.labels || "[]").filter((l) => l && l.trim() !== "");
        const valuesRaw = JSON.parse(canvas.dataset.values || "[]");
        const values = valuesRaw.slice(0, labels.length).map((v) => (Number.isFinite(Number(v)) ? Number(v) : 0));
        const percents = normalizePercents(values);
        const kind = canvas.dataset.kind || "SINGLE";

        const backgroundColor = [];
        const borderColor = [];
        for (let i = 0; i < labels.length; i++) {
          const color = baseColors[i % baseColors.length];
          backgroundColor.push(color.bg);
          borderColor.push(color.border);
        }

        const chartType = kind === "SINGLE" ? "doughnut" : "bar";

        new Chart(canvas, {
          type: chartType,
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: backgroundColor,
                borderColor: borderColor,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                    const percent = percents[context.dataIndex];
                    return `${label}: ${value} (${percent}%)`;
                  },
                },
              },
            },
            ...(kind === "SINGLE"
              ? { cutout: "60%" }
              : {
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: { stepSize: 1, precision: 0 },
                      title: { display: true, text: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤" },
                    },
                    x: {
                      title: { display: true, text: "–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞" },
                    },
                  },
                }),
          },
        });
      }

      document.querySelectorAll('[data-chart="stats"]').forEach(initChart);

      // –ü–æ–∫—Ä–∞—à–∏–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –≤ —Ç–µ –∂–µ —Ü–≤–µ—Ç–∞, —á—Ç–æ –∏ –¥–∏–∞–≥—Ä–∞–º–º–∞
      document.querySelectorAll("li[data-choice-color]").forEach((item) => {
        const color = item.getAttribute("data-choice-color");
        if (!color) return;
        item.style.color = color;
        const dot = item.querySelector(".choice-dot");
        const meta = item.querySelector(".choice-meta");
        if (dot) dot.style.background = color;
        if (meta) meta.style.color = color;
      });
    });
  </script>
{% endblock %}
