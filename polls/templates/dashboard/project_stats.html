
{% extends "dashboard/base.html" %}
{% load static %}

{% block dashboard_title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {{ poll.title }}{% endblock %}

{% block content %}
  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="mb-8">
    <a href="{% url 'polls:project_detail' poll_id=poll.id %}"
       class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-indigo-600 transition-all duration-300 transform hover:scale-105">
      <i class="fas fa-arrow-left"></i>
      <span>–ù–∞–∑–∞–¥ –∫ –æ–ø—Ä–æ—Å—É</span>
    </a>
  </div>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-800"> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
      <h2 class="text-lg text-gray-600 mt-1">{{ poll.title }}</h2>
    </div>
    <a href="{% url 'polls:project_responses' poll_id=poll.id %}"
       class="inline-flex items-center gap-3 mt-4 md:mt-0 bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-semibold py-3 px-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110">
      <i class="fas fa-eye"></i>
      <span>–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–≤–µ—Ç–æ–≤</span>
    </a>
  </div>

  <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-2xl shadow-xl overflow-hidden mb-10">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-8">
      <div class="text-center">
        <div class="text-5xl font-extrabold mb-2">{{ total_submissions }}</div>
        <div class="opacity-90">–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫</div>
      </div>
      <div class="text-center">
        <div class="text-4xl font-bold mb-2 font-mono">{{ poll.access_code }}</div>
        <div class="opacity-90">–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</div>
      </div>
      <div class="text-center">
        <a href="{% url 'polls:poll_public' access_code=poll.access_code %}" target="_blank"
           class="underline opacity-90 hover:opacity-100 transition duration-200">
          –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ ‚Üí
        </a>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º -->
  {% if questions_stats %}
    {% for q in questions_stats %}
      <div class="bg-white rounded-2xl shadow-lg border border-gray-200/70 mb-8 overflow-hidden transition-all duration-300 hover:shadow-2xl animate-fade-in-up">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–æ–ø—Ä–æ—Å–∞ -->
        <div class="flex items-center gap-4 p-6 border-b border-gray-200 bg-gray-50">
          <span class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold shadow-lg">
            {{ forloop.counter }}
          </span>
          <div class="flex-1">
            <h3 class="text-xl font-bold text-gray-800">{{ q.text }}</h3>
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 mt-1 text-xs font-semibold rounded-full
              {% if q.kind == 'TEXT' %}bg-blue-100 text-blue-700
              {% elif q.kind == 'SINGLE' %}bg-green-100 text-green-700
              {% else %}bg-amber-100 text-amber-700
              {% endif %}">
              {% if q.kind == 'TEXT' %}
                <i class="fas fa-align-left text-xs"></i> –¢–µ–∫—Å—Ç
              {% elif q.kind == 'SINGLE' %}
                <i class="fas fa-dot-circle text-xs"></i> –û–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä
              {% else %}
                <i class="fas fa-check-square text-xs"></i> –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
              {% endif %}
            </span>
          </div>
        </div>

        <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã -->
        {% if q.kind == 'TEXT' %}
          <div class="p-8 text-center bg-gray-50">
            <div class="text-4xl mb-2">üìù</div>
            <div class="text-gray-500 mb-4">–¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã</div>
            <a href="{% url 'polls:project_responses' poll_id=poll.id %}?text=&limit=200"
               class="inline-flex items-center gap-2 bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50 font-medium py-2 px-5 rounded-xl transition">
              <i class="fas fa-eye"></i>
              <span>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã</span>
            </a>
          </div>

        <!-- –í–æ–ø—Ä–æ—Å—ã —Å –≤—ã–±–æ—Ä–æ–º -->
        {% else %}
          {% if q.choices %}
            <div class="p-6">
              <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ -->
              <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">üìä –î–∏–∞–≥—Ä–∞–º–º–∞</h4>
                <div class="h-80">
                  <canvas id="chart-{{ q.id }}"
                          data-chart="stats"
                          data-kind="{{ q.kind }}"
                          data-labels='[{% for c in q.choices %}"{{ c.text|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}]'
                          data-values='[{% for c in q.choices %}{{ c.count }}{% if not forloop.last %},{% endif %}{% endfor %}]'>
                  </canvas>
                </div>
              </div>

              <!-- –î–µ—Ç–∞–ª–∏ -->
              <div>
                <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">–î–µ—Ç–∞–ª–∏</h4>
                <ul class="space-y-2">
                  {% for c in q.choices %}
                    {% cycle '#6366f1' '#8b5cf6' '#10b981' '#f59e0b' '#ef4444' '#3b82f6' '#ec4899' '#22c55e' '#0ea5e9' '#f472b6' '#fbbf24' '#4f46e5' '#4338ca' '#0f766e' '#5eead4' '#94a3b8' as choice_color silent %}
                    <li class="flex justify-between items-center p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition group"
                        data-choice-color="{{ choice_color }}">
                      <span class="flex items-center gap-3 flex-1">
                        <span class="w-3 h-3 rounded-full"
                              style="background-color: {{ choice_color }};"></span>
                        <span class="text-gray-700 group-hover:text-gray-900 transition">{{ c.text }}</span>
                      </span>
                      <span class="font-semibold text-gray-800"
                            style="color: {{ choice_color }};">{{ c.percent|floatformat:0 }}% ({{ c.count }})</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          {% else %}
            <div class="p-12 text-center text-gray-500">
              <div class="text-4xl mb-4">‚ùì</div>
              <p>–ü–æ–∫–∞ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.</p>
            </div>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/70 p-12 text-center">
      <div class="text-6xl mb-6">üìä</div>
      <h3 class="text-2xl font-bold text-gray-800 mb-4">–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤</h3>
      <p class="text-gray-600 mb-6">
        –î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –∫ –æ–ø—Ä–æ—Å—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
      </p>
      <a href="{% url 'polls:question_new' poll_id=poll.id %}"
         class="inline-flex items-center gap-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
        <i class="fas fa-plus"></i>
        <span>–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</span>
      </a>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="{% static 'js/charts.js' %}" defer></script>
{% endblock %}