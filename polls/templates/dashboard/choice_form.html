<!-- polls/templates/dashboard/choice_form.html -->
{% extends "base.html" %}

{% block title %}{% if choice %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç{% else %}–ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç{% endif %}{% endblock %}

{% block content %}
<div class="container">
  <h1>{% if choice %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç{% else %}–ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç{% endif %}</h1>

  <!-- === –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ (–æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ —É –≤–∞—Å) === -->
  {% if question.is_test_question %}
    <div class="info" style="background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
      <strong>üß™ –¢–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</strong> ‚Äî –º–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å <em>–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</em>.
    </div>
  {% else %}
    <div class="info" style="background: #fef3c7; color: #92400e; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 4px solid #f59e0b;">
      <strong>üìå –û–±—ã—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å</strong> ‚Äî –Ω–µ–ª—å–∑—è –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç.
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    <!-- –ü–æ–ª–µ: —Ç–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞ -->
    <div class="form-group">
      <label for="{{ form.text.id_for_label }}" class="form-label">–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞</label>
      <input
        type="text"
        name="text"
        value="{{ form.text.value|default:'' }}"
        class="form-control"
        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞"
        required
      >
      {% if form.text.errors %}
        <div class="error" style="color: #e11d48; font-size: 0.875rem; margin-top: 0.25rem;">
          {{ form.text.errors|first }}
        </div>
      {% endif %}
    </div>

    <!-- –ü–æ–ª–µ: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç -->
    {% if question.is_test_question %}
      <div class="form-group" style="margin-top: 1.5rem;">
        <div class="flex" style="align-items: center; gap: 0.5rem;">
          <input
            type="checkbox"
            name="is_correct"
            id="id_is_correct"
            {% if form.is_correct.value %}checked{% endif %}
            class="form-check-input"
            {% if question.kind == "SINGLE" %}data-single-choice="true"{% endif %}
          >
          <label for="id_is_correct" class="form-check-label" style="font-weight: 500; color: #1e293b;">
            ‚úÖ –≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
          </label>
        </div>
        <div class="text-muted small" style="margin-top: 0.25rem; font-size: 0.875rem; color: #64748b;">
          –û—Ç–º–µ—Ç—å—Ç–µ, –µ—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å.
        </div>

        <!-- üîπ –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ) -->
        {% if question.kind == "SINGLE" %}
          <div 
            id="single-warning" 
            style="display: none; margin-top: 0.75rem; padding: 0.5rem; background: #fff1f2; color: #dc2626; border-radius: 0.375rem; font-size: 0.875rem; border-left: 3px solid #ef4444;">
            ‚ùó –í –≤–æ–ø—Ä–æ—Å–µ —Å –æ–¥–∏–Ω–æ—á–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –º–æ–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ <strong>–æ–¥–∏–Ω</strong> –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.
          </div>
        {% endif %}

        {% if form.is_correct.errors %}
          <div class="error" style="color: #e11d48; font-size: 0.875rem; margin-top: 0.5rem;">
            {{ form.is_correct.errors|first }}
          </div>
        {% endif %}
      </div>
    {% else %}
      <input type="hidden" name="is_correct" value="" />
    {% endif %}

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="flex" style="margin-top: 2rem; gap: 1rem;">
      <button type="submit" class="btn btn-primary">
        {% if choice %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç{% endif %}
      </button>
      <a href="{% url 'polls:project_detail' poll.id %}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
    </div>
  </form>
</div>

<!-- üîπ JavaScript –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
{% if question.kind == "SINGLE" %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkbox = document.getElementById('id_is_correct');
  const warning = document.getElementById('single-warning');

  if (!checkbox || !warning) return;

  // –ü–æ–ª—É—á–∞–µ–º ID –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ URL –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—ë–º —è–≤–Ω–æ (–Ω–∞–¥—ë–∂–Ω–µ–µ ‚Äî –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞)
  // –ù–æ –ø—Ä–æ—â–µ: –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ.
  // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã ‚Äî –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ: –µ—Å–ª–∏ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º.

  checkbox.addEventListener('change', function() {
    if (this.checked) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ —É–∂–µ –¥—Ä—É–≥–æ–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç?
      // ‚Üí –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
      fetch(`/api/question/{{ question.id }}/correct-count/`)
        .then(response => response.json())
        .then(data => {
          // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
          const currentIsCorrect = {% if choice and choice.is_correct %}true{% else %}false{% endif %};
          const count = data.count - (currentIsCorrect ? 1 : 0);

          if (count >= 1) {
            warning.style.display = 'block';
            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫, —á—Ç–æ–±—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ –æ—à–∏–±–∫–µ
            setTimeout(() => {
              if (checkbox.checked && warning.style.display === 'block') {
                checkbox.checked = false;
                warning.style.display = 'none';
              }
            }, 2000);
          } else {
            warning.style.display = 'none';
          }
        })
        .catch(err => {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:', err);
          warning.style.display = 'none';
        });
    } else {
      warning.style.display = 'none';
    }
  });
});
</script>
{% endif %}
{% endblock %}